# 智库内容管理系统 - 部署指南

## 🌐 部署架构

```
Internet → Nginx (80/443) → Gunicorn (8000) → Django App → SQLite/PostgreSQL
```

---

## 📋 部署前准备

### 1. 服务器要求

- **操作系统**: Ubuntu 20.04+ / CentOS 7+ / Windows Server
- **Python**: 3.10 或更高版本
- **内存**: 至少 2GB RAM
- **磁盘**: 至少 10GB 可用空间
- **浏览器**: Chrome（用于爬虫功能）

### 2. 必需软件

```bash
# Ubuntu/Debian
sudo apt update
sudo apt install python3 python3-pip python3-venv nginx
sudo apt install chromium-browser chromium-chromedriver  # 爬虫需要

# CentOS/RHEL
sudo yum install python3 python3-pip nginx
```

---

## 🚀 详细部署步骤

### 第一步：上传项目文件

```bash
# 创建项目目录
sudo mkdir -p /var/www/thinktank
sudo chown $USER:$USER /var/www/thinktank

# 上传项目文件到此目录
# 使用 scp, rsync, git 等方式
```

### 第二步：创建虚拟环境

```bash
cd /var/www/thinktank
python3 -m venv venv
source venv/bin/activate
```

### 第三步：安装依赖

```bash
pip install --upgrade pip
pip install -r requirements.txt
```

### 第四步：配置 Django 设置

编辑 `thinktank_project/settings.py`：

```python
# 生产环境设置
DEBUG = False

ALLOWED_HOSTS = [
    'your-domain.com',
    'www.your-domain.com',
    'your-server-ip',
]

# 静态文件配置
STATIC_ROOT = os.path.join(BASE_DIR, 'staticfiles')
STATIC_URL = '/static/'

# 中间件配置（添加 WhiteNoise）
MIDDLEWARE = [
    'django.middleware.security.SecurityMiddleware',
    'whitenoise.middleware.WhiteNoiseMiddleware',  # 添加
    'django.contrib.sessions.middleware.SessionMiddleware',
    # ... 其他中间件
]

# 数据库配置（可选：使用 PostgreSQL）
# DATABASES = {
#     'default': {
#         'ENGINE': 'django.db.backends.postgresql',
#         'NAME': 'thinktank_db',
#         'USER': 'thinktank_user',
#         'PASSWORD': 'your_password',
#         'HOST': 'localhost',
#         'PORT': '5432',
#     }
# }

# 安全设置
SECURE_BROWSER_XSS_FILTER = True
SECURE_CONTENT_TYPE_NOSNIFF = True
X_FRAME_OPTIONS = 'DENY'

# 如果使用 HTTPS
# SECURE_SSL_REDIRECT = True
# SESSION_COOKIE_SECURE = True
# CSRF_COOKIE_SECURE = True
```

### 第五步：初始化数据库

```bash
python manage.py makemigrations
python manage.py migrate
python manage.py init_thinktanks
python manage.py collectstatic --noinput
```

### 第六步：创建管理员账户

```bash
python manage.py createsuperuser
```

### 第七步：测试运行

```bash
python manage.py runserver 0.0.0.0:8000
# 浏览器访问 http://your-server-ip:8000 测试
# Ctrl+C 停止
```

---

## 🔧 配置 Gunicorn（生产环境）

### 1. 测试 Gunicorn

```bash
gunicorn thinktank_project.wsgi:application --bind 0.0.0.0:8000
```

### 2. 创建 Gunicorn 配置文件

创建 `gunicorn_config.py`：

```python
import multiprocessing

# 服务器绑定
bind = "127.0.0.1:8000"

# Worker 进程数（通常为 CPU 核心数 * 2 + 1）
workers = multiprocessing.cpu_count() * 2 + 1

# Worker 类型
worker_class = "sync"

# 超时时间（秒）
timeout = 120

# 日志
accesslog = "/var/log/thinktank/access.log"
errorlog = "/var/log/thinktank/error.log"
loglevel = "info"

# 进程名称
proc_name = "thinktank"
```

创建日志目录：
```bash
sudo mkdir -p /var/log/thinktank
sudo chown $USER:$USER /var/log/thinktank
```

### 3. 创建 Systemd 服务

创建 `/etc/systemd/system/thinktank.service`：

```ini
[Unit]
Description=Thinktank Django Application
After=network.target

[Service]
Type=notify
User=www-data
Group=www-data
WorkingDirectory=/var/www/thinktank
Environment="PATH=/var/www/thinktank/venv/bin"

ExecStart=/var/www/thinktank/venv/bin/gunicorn \
    --config /var/www/thinktank/gunicorn_config.py \
    thinktank_project.wsgi:application

ExecReload=/bin/kill -s HUP $MAINPID
KillMode=mixed
TimeoutStopSec=5
PrivateTmp=true

Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
```

启动服务：
```bash
sudo systemctl daemon-reload
sudo systemctl start thinktank
sudo systemctl enable thinktank
sudo systemctl status thinktank
```

---

## 🌐 配置 Nginx

### 1. 创建 Nginx 配置

创建 `/etc/nginx/sites-available/thinktank`：

```nginx
upstream thinktank_app {
    server 127.0.0.1:8000 fail_timeout=0;
}

server {
    listen 80;
    server_name your-domain.com www.your-domain.com;

    client_max_body_size 50M;
    
    # 访问日志
    access_log /var/log/nginx/thinktank_access.log;
    error_log /var/log/nginx/thinktank_error.log;

    # 静态文件
    location /static/ {
        alias /var/www/thinktank/staticfiles/;
        expires 30d;
        add_header Cache-Control "public, immutable";
    }

    # 媒体文件（如果有）
    location /media/ {
        alias /var/www/thinktank/media/;
    }

    # Django 应用
    location / {
        proxy_pass http://thinktank_app;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_redirect off;
        
        # 超时设置
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }
}
```

### 2. 启用配置

```bash
sudo ln -s /etc/nginx/sites-available/thinktank /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl restart nginx
```

### 3. 配置防火墙

```bash
# Ubuntu/Debian
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp
sudo ufw enable

# CentOS/RHEL
sudo firewall-cmd --permanent --add-service=http
sudo firewall-cmd --permanent --add-service=https
sudo firewall-cmd --reload
```

---

## 🔒 配置 HTTPS（可选但推荐）

### 使用 Let's Encrypt

```bash
# 安装 Certbot
sudo apt install certbot python3-certbot-nginx  # Ubuntu/Debian

# 获取证书并自动配置 Nginx
sudo certbot --nginx -d your-domain.com -d www.your-domain.com

# 测试自动续期
sudo certbot renew --dry-run
```

---

## 📊 性能优化

### 1. 配置数据库连接池

在 `settings.py` 中：

```python
DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.postgresql',
        'NAME': 'thinktank_db',
        'USER': 'thinktank_user',
        'PASSWORD': 'your_password',
        'HOST': 'localhost',
        'PORT': '5432',
        'CONN_MAX_AGE': 600,  # 连接池
    }
}
```

### 2. 启用 Gzip 压缩

在 Nginx 配置中添加：

```nginx
gzip on;
gzip_vary on;
gzip_proxied any;
gzip_comp_level 6;
gzip_types text/plain text/css text/xml text/javascript application/json application/javascript application/xml+rss application/rss+xml font/truetype font/opentype application/vnd.ms-fontobject image/svg+xml;
```

---

## 🔄 更新部署

```bash
# 1. 拉取最新代码
cd /var/www/thinktank
git pull  # 如果使用 Git

# 2. 激活虚拟环境
source venv/bin/activate

# 3. 更新依赖
pip install -r requirements.txt --upgrade

# 4. 数据库迁移
python manage.py migrate

# 5. 收集静态文件
python manage.py collectstatic --noinput

# 6. 重启服务
sudo systemctl restart thinktank
```

---

## 🐛 常见问题

### 1. 静态文件无法加载

```bash
# 检查权限
sudo chown -R www-data:www-data /var/www/thinktank/staticfiles/
sudo chmod -R 755 /var/www/thinktank/staticfiles/

# 重新收集
python manage.py collectstatic --clear
python manage.py collectstatic --noinput
```

### 2. 502 Bad Gateway

```bash
# 检查 Gunicorn 状态
sudo systemctl status thinktank

# 查看日志
sudo journalctl -u thinktank -n 50

# 检查端口占用
sudo netstat -tlnp | grep 8000
```

### 3. 爬虫无法运行

```bash
# 确保安装了 Chrome/Chromium
google-chrome --version
# 或
chromium-browser --version

# 检查 ChromeDriver
which chromedriver
```

---

## 📝 维护任务

### 定期备份数据库

```bash
# 备份 SQLite
cp /var/www/thinktank/thinktank.db /backup/thinktank_$(date +%Y%m%d).db

# 备份 PostgreSQL
pg_dump -U thinktank_user thinktank_db > /backup/thinktank_$(date +%Y%m%d).sql
```

### 定期清理日志

```bash
# 添加到 crontab
sudo crontab -e

# 每周清理旧日志
0 0 * * 0 find /var/log/thinktank/ -name "*.log" -mtime +30 -delete
```

---

## ✅ 部署检查清单

- [ ] Python 3.10+ 已安装
- [ ] 虚拟环境已创建
- [ ] 依赖包已安装
- [ ] DEBUG = False
- [ ] ALLOWED_HOSTS 已配置
- [ ] 数据库已迁移
- [ ] 静态文件已收集
- [ ] Gunicorn 服务正常运行
- [ ] Nginx 配置正确
- [ ] 防火墙端口已开放
- [ ] HTTPS 已配置（推荐）
- [ ] 定期备份已设置

---

**部署完成后，访问 http://your-domain.com 即可使用系统！** 🎉

