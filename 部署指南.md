# æ™ºåº“å†…å®¹ç®¡ç†ç³»ç»Ÿ - éƒ¨ç½²æŒ‡å—

## ğŸŒ éƒ¨ç½²æ¶æ„

```
Internet â†’ Nginx (80/443) â†’ Gunicorn (8000) â†’ Django App â†’ SQLite/PostgreSQL
```

---

## ğŸ“‹ éƒ¨ç½²å‰å‡†å¤‡

### 1. æœåŠ¡å™¨è¦æ±‚

- **æ“ä½œç³»ç»Ÿ**: Ubuntu 20.04+ / CentOS 7+ / Windows Server
- **Python**: 3.10 æˆ–æ›´é«˜ç‰ˆæœ¬
- **å†…å­˜**: è‡³å°‘ 2GB RAM
- **ç£ç›˜**: è‡³å°‘ 10GB å¯ç”¨ç©ºé—´
- **æµè§ˆå™¨**: Chromeï¼ˆç”¨äºçˆ¬è™«åŠŸèƒ½ï¼‰

### 2. å¿…éœ€è½¯ä»¶

```bash
# Ubuntu/Debian
sudo apt update
sudo apt install python3 python3-pip python3-venv nginx
sudo apt install chromium-browser chromium-chromedriver  # çˆ¬è™«éœ€è¦

# CentOS/RHEL
sudo yum install python3 python3-pip nginx
```

---

## ğŸš€ è¯¦ç»†éƒ¨ç½²æ­¥éª¤

### ç¬¬ä¸€æ­¥ï¼šä¸Šä¼ é¡¹ç›®æ–‡ä»¶

```bash
# åˆ›å»ºé¡¹ç›®ç›®å½•
sudo mkdir -p /var/www/thinktank
sudo chown $USER:$USER /var/www/thinktank

# ä¸Šä¼ é¡¹ç›®æ–‡ä»¶åˆ°æ­¤ç›®å½•
# ä½¿ç”¨ scp, rsync, git ç­‰æ–¹å¼
```

### ç¬¬äºŒæ­¥ï¼šåˆ›å»ºè™šæ‹Ÿç¯å¢ƒ

```bash
cd /var/www/thinktank
python3 -m venv venv
source venv/bin/activate
```

### ç¬¬ä¸‰æ­¥ï¼šå®‰è£…ä¾èµ–

```bash
pip install --upgrade pip
pip install -r requirements.txt
```

### ç¬¬å››æ­¥ï¼šé…ç½® Django è®¾ç½®

ç¼–è¾‘ `thinktank_project/settings.py`ï¼š

```python
# ç”Ÿäº§ç¯å¢ƒè®¾ç½®
DEBUG = False

ALLOWED_HOSTS = [
    'your-domain.com',
    'www.your-domain.com',
    'your-server-ip',
]

# é™æ€æ–‡ä»¶é…ç½®
STATIC_ROOT = os.path.join(BASE_DIR, 'staticfiles')
STATIC_URL = '/static/'

# ä¸­é—´ä»¶é…ç½®ï¼ˆæ·»åŠ  WhiteNoiseï¼‰
MIDDLEWARE = [
    'django.middleware.security.SecurityMiddleware',
    'whitenoise.middleware.WhiteNoiseMiddleware',  # æ·»åŠ 
    'django.contrib.sessions.middleware.SessionMiddleware',
    # ... å…¶ä»–ä¸­é—´ä»¶
]

# æ•°æ®åº“é…ç½®ï¼ˆå¯é€‰ï¼šä½¿ç”¨ PostgreSQLï¼‰
# DATABASES = {
#     'default': {
#         'ENGINE': 'django.db.backends.postgresql',
#         'NAME': 'thinktank_db',
#         'USER': 'thinktank_user',
#         'PASSWORD': 'your_password',
#         'HOST': 'localhost',
#         'PORT': '5432',
#     }
# }

# å®‰å…¨è®¾ç½®
SECURE_BROWSER_XSS_FILTER = True
SECURE_CONTENT_TYPE_NOSNIFF = True
X_FRAME_OPTIONS = 'DENY'

# å¦‚æœä½¿ç”¨ HTTPS
# SECURE_SSL_REDIRECT = True
# SESSION_COOKIE_SECURE = True
# CSRF_COOKIE_SECURE = True
```

### ç¬¬äº”æ­¥ï¼šåˆå§‹åŒ–æ•°æ®åº“

```bash
python manage.py makemigrations
python manage.py migrate
python manage.py init_thinktanks
python manage.py collectstatic --noinput
```

### ç¬¬å…­æ­¥ï¼šåˆ›å»ºç®¡ç†å‘˜è´¦æˆ·

```bash
python manage.py createsuperuser
```

### ç¬¬ä¸ƒæ­¥ï¼šæµ‹è¯•è¿è¡Œ

```bash
python manage.py runserver 0.0.0.0:8000
# æµè§ˆå™¨è®¿é—® http://your-server-ip:8000 æµ‹è¯•
# Ctrl+C åœæ­¢
```

---

## ğŸ”§ é…ç½® Gunicornï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰

### 1. æµ‹è¯• Gunicorn

```bash
gunicorn thinktank_project.wsgi:application --bind 0.0.0.0:8000
```

### 2. åˆ›å»º Gunicorn é…ç½®æ–‡ä»¶

åˆ›å»º `gunicorn_config.py`ï¼š

```python
import multiprocessing

# æœåŠ¡å™¨ç»‘å®š
bind = "127.0.0.1:8000"

# Worker è¿›ç¨‹æ•°ï¼ˆé€šå¸¸ä¸º CPU æ ¸å¿ƒæ•° * 2 + 1ï¼‰
workers = multiprocessing.cpu_count() * 2 + 1

# Worker ç±»å‹
worker_class = "sync"

# è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰
timeout = 120

# æ—¥å¿—
accesslog = "/var/log/thinktank/access.log"
errorlog = "/var/log/thinktank/error.log"
loglevel = "info"

# è¿›ç¨‹åç§°
proc_name = "thinktank"
```

åˆ›å»ºæ—¥å¿—ç›®å½•ï¼š
```bash
sudo mkdir -p /var/log/thinktank
sudo chown $USER:$USER /var/log/thinktank
```

### 3. åˆ›å»º Systemd æœåŠ¡

åˆ›å»º `/etc/systemd/system/thinktank.service`ï¼š

```ini
[Unit]
Description=Thinktank Django Application
After=network.target

[Service]
Type=notify
User=www-data
Group=www-data
WorkingDirectory=/var/www/thinktank
Environment="PATH=/var/www/thinktank/venv/bin"

ExecStart=/var/www/thinktank/venv/bin/gunicorn \
    --config /var/www/thinktank/gunicorn_config.py \
    thinktank_project.wsgi:application

ExecReload=/bin/kill -s HUP $MAINPID
KillMode=mixed
TimeoutStopSec=5
PrivateTmp=true

Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
```

å¯åŠ¨æœåŠ¡ï¼š
```bash
sudo systemctl daemon-reload
sudo systemctl start thinktank
sudo systemctl enable thinktank
sudo systemctl status thinktank
```

---

## ğŸŒ é…ç½® Nginx

### 1. åˆ›å»º Nginx é…ç½®

åˆ›å»º `/etc/nginx/sites-available/thinktank`ï¼š

```nginx
upstream thinktank_app {
    server 127.0.0.1:8000 fail_timeout=0;
}

server {
    listen 80;
    server_name your-domain.com www.your-domain.com;

    client_max_body_size 50M;
    
    # è®¿é—®æ—¥å¿—
    access_log /var/log/nginx/thinktank_access.log;
    error_log /var/log/nginx/thinktank_error.log;

    # é™æ€æ–‡ä»¶
    location /static/ {
        alias /var/www/thinktank/staticfiles/;
        expires 30d;
        add_header Cache-Control "public, immutable";
    }

    # åª’ä½“æ–‡ä»¶ï¼ˆå¦‚æœæœ‰ï¼‰
    location /media/ {
        alias /var/www/thinktank/media/;
    }

    # Django åº”ç”¨
    location / {
        proxy_pass http://thinktank_app;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_redirect off;
        
        # è¶…æ—¶è®¾ç½®
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }
}
```

### 2. å¯ç”¨é…ç½®

```bash
sudo ln -s /etc/nginx/sites-available/thinktank /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl restart nginx
```

### 3. é…ç½®é˜²ç«å¢™

```bash
# Ubuntu/Debian
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp
sudo ufw enable

# CentOS/RHEL
sudo firewall-cmd --permanent --add-service=http
sudo firewall-cmd --permanent --add-service=https
sudo firewall-cmd --reload
```

---

## ğŸ”’ é…ç½® HTTPSï¼ˆå¯é€‰ä½†æ¨èï¼‰

### ä½¿ç”¨ Let's Encrypt

```bash
# å®‰è£… Certbot
sudo apt install certbot python3-certbot-nginx  # Ubuntu/Debian

# è·å–è¯ä¹¦å¹¶è‡ªåŠ¨é…ç½® Nginx
sudo certbot --nginx -d your-domain.com -d www.your-domain.com

# æµ‹è¯•è‡ªåŠ¨ç»­æœŸ
sudo certbot renew --dry-run
```

---

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–

### 1. é…ç½®æ•°æ®åº“è¿æ¥æ± 

åœ¨ `settings.py` ä¸­ï¼š

```python
DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.postgresql',
        'NAME': 'thinktank_db',
        'USER': 'thinktank_user',
        'PASSWORD': 'your_password',
        'HOST': 'localhost',
        'PORT': '5432',
        'CONN_MAX_AGE': 600,  # è¿æ¥æ± 
    }
}
```

### 2. å¯ç”¨ Gzip å‹ç¼©

åœ¨ Nginx é…ç½®ä¸­æ·»åŠ ï¼š

```nginx
gzip on;
gzip_vary on;
gzip_proxied any;
gzip_comp_level 6;
gzip_types text/plain text/css text/xml text/javascript application/json application/javascript application/xml+rss application/rss+xml font/truetype font/opentype application/vnd.ms-fontobject image/svg+xml;
```

---

## ğŸ”„ æ›´æ–°éƒ¨ç½²

```bash
# 1. æ‹‰å–æœ€æ–°ä»£ç 
cd /var/www/thinktank
git pull  # å¦‚æœä½¿ç”¨ Git

# 2. æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
source venv/bin/activate

# 3. æ›´æ–°ä¾èµ–
pip install -r requirements.txt --upgrade

# 4. æ•°æ®åº“è¿ç§»
python manage.py migrate

# 5. æ”¶é›†é™æ€æ–‡ä»¶
python manage.py collectstatic --noinput

# 6. é‡å¯æœåŠ¡
sudo systemctl restart thinktank
```

---

## ğŸ› å¸¸è§é—®é¢˜

### 1. é™æ€æ–‡ä»¶æ— æ³•åŠ è½½

```bash
# æ£€æŸ¥æƒé™
sudo chown -R www-data:www-data /var/www/thinktank/staticfiles/
sudo chmod -R 755 /var/www/thinktank/staticfiles/

# é‡æ–°æ”¶é›†
python manage.py collectstatic --clear
python manage.py collectstatic --noinput
```

### 2. 502 Bad Gateway

```bash
# æ£€æŸ¥ Gunicorn çŠ¶æ€
sudo systemctl status thinktank

# æŸ¥çœ‹æ—¥å¿—
sudo journalctl -u thinktank -n 50

# æ£€æŸ¥ç«¯å£å ç”¨
sudo netstat -tlnp | grep 8000
```

### 3. çˆ¬è™«æ— æ³•è¿è¡Œ

```bash
# ç¡®ä¿å®‰è£…äº† Chrome/Chromium
google-chrome --version
# æˆ–
chromium-browser --version

# æ£€æŸ¥ ChromeDriver
which chromedriver
```

---

## ğŸ“ ç»´æŠ¤ä»»åŠ¡

### å®šæœŸå¤‡ä»½æ•°æ®åº“

```bash
# å¤‡ä»½ SQLite
cp /var/www/thinktank/thinktank.db /backup/thinktank_$(date +%Y%m%d).db

# å¤‡ä»½ PostgreSQL
pg_dump -U thinktank_user thinktank_db > /backup/thinktank_$(date +%Y%m%d).sql
```

### å®šæœŸæ¸…ç†æ—¥å¿—

```bash
# æ·»åŠ åˆ° crontab
sudo crontab -e

# æ¯å‘¨æ¸…ç†æ—§æ—¥å¿—
0 0 * * 0 find /var/log/thinktank/ -name "*.log" -mtime +30 -delete
```

---

## âœ… éƒ¨ç½²æ£€æŸ¥æ¸…å•

- [ ] Python 3.10+ å·²å®‰è£…
- [ ] è™šæ‹Ÿç¯å¢ƒå·²åˆ›å»º
- [ ] ä¾èµ–åŒ…å·²å®‰è£…
- [ ] DEBUG = False
- [ ] ALLOWED_HOSTS å·²é…ç½®
- [ ] æ•°æ®åº“å·²è¿ç§»
- [ ] é™æ€æ–‡ä»¶å·²æ”¶é›†
- [ ] Gunicorn æœåŠ¡æ­£å¸¸è¿è¡Œ
- [ ] Nginx é…ç½®æ­£ç¡®
- [ ] é˜²ç«å¢™ç«¯å£å·²å¼€æ”¾
- [ ] HTTPS å·²é…ç½®ï¼ˆæ¨èï¼‰
- [ ] å®šæœŸå¤‡ä»½å·²è®¾ç½®

---

**éƒ¨ç½²å®Œæˆåï¼Œè®¿é—® http://your-domain.com å³å¯ä½¿ç”¨ç³»ç»Ÿï¼** ğŸ‰

