<!-- webui/templates/webui/articles.html -->
{% extends "base.html" %}
{% load static string_filters %} 

{% block title %}文章列表 - 智库内容管理系统{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>
        <i class="fas fa-newspaper me-2"></i>文章列表
    </h2>
    <div class="text-muted">
        <!-- 修改点1: 假设 pagination 是一个字典，或者你传递了 articles.total_count 等 -->
        <!-- Django Paginator 的 Page 对象没有 total 属性，需要从 paginator 或查询集获取 -->
        <!-- 这里假设你在视图中计算了 total 并传递了 -->
        共 {{ pagination.total }} 篇文章，第 {{ articles.number }} / {{ pagination.total_pages }} 页
    </div>
</div>

{% if articles %}
    <!-- 文章列表 -->
    <div class="row">
        {% for article in articles %}
        <div class="col-12 mb-3">
            <div class="card">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-8">
                            <h5 class="card-title mb-2">
                                <!-- 修改点2: url_for -> url -->
                                <a href="{% url 'webui:article_detail' article_id=article.id %}" class="article-title">
                                    {{ article.title }}
                                </a>
                            </h5>
                            

                            <div class="mb-2">
                                <a href="{% url 'webui:thinktank_detail' thinktank_id=article.thinktank.id %}" class="badge bg-primary text-decoration-none">
                                    {{ article.thinktank.name }}
                                </a>
                                
                            </div>
                            

                            {% if article.summary %}
                                <p class="card-text text-muted mb-2">
                                    <!-- 修改点4: [:200] -> truncatechars -->
                                    {{ article.summary|truncatechars:200 }}
                                </p>
                            {% endif %}

                            <div class="text-muted small">
                                {% if article.author %}
                                    <i class="fas fa-user me-1"></i>{{ article.author }}
                                    <span class="mx-2">|</span>
                                {% endif %}
                                <i class="fas fa-calendar me-1"></i>
                                {% if article.publish_date %}
                                    <!-- 修改点5: strftime -> date -->
                                    {{ article.publish_date|date:"Y-m-d" }}
                                {% else %}
                                    <!-- 修改点5: strftime -> date -->
                                    {{ article.crawl_date|date:"Y-m-d" }}
                                {% endif %}
                                <span class="mx-2">|</span>
                                <i class="fas fa-eye me-1"></i>
                                <!-- 修改点6: or 0 -> default:0 -->
                                {{ article.view_count|default:0 }} 次浏览
                                <span class="mx-2">|</span>
                                <i class="fas fa-clock me-1"></i>
                                <!-- 修改点7: strftime -> date -->
                                {{ article.crawl_date|date:"Y-m-d H:i" }} 爬取
                            </div>
                        </div>

                        <div class="col-md-4 text-md-end">
                            <div class="btn-group-vertical" role="group">
                                <!-- 修改点8: url_for -> url -->
                                <a href="{% url 'webui:article_detail' article_id=article.id %}" class="btn btn-sm btn-outline-primary mb-1">
                                    <i class="fas fa-eye me-1"></i>查看详情
                                </a>

                                {% if article.digest and article.digest.is_fully_filled %}
                                    <!-- 修改点9: url_for -> url -->
                                    <a href="{% url 'webui:digest_detail' article_id=article.id %}" class="btn btn-sm btn-success mb-1">
                                        <i class="fas fa-check me-1"></i>查看摘编
                                    </a>
                                {% else %}
                                    <!-- 修改点10: url_for -> url -->
                                    <a href="{% url 'webui:digest_edit' article_id=article.id %}" class="btn btn-sm btn-outline-warning mb-1">
                                        <i class="fas fa-edit me-1"></i>创建摘编
                                    </a>
                                {% endif %}

                                <a href="{{ article.url }}" target="_blank" class="btn btn-sm btn-outline-secondary">
                                    <i class="fas fa-external-link-alt me-1"></i>原文链接
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- 分页导航 -->
    <!-- 修改点11: 分页逻辑 -->
    <!-- 分页导航 -->
{% if articles.has_other_pages %}
<nav aria-label="文章分页">
    <ul class="pagination justify-content-center">
        <!-- 上一页 -->
        {% if articles.has_previous %}
            <li class="page-item">
                <a class="page-link" href="{% url 'webui:articles' %}?page={{ articles.previous_page_number }}{% if request.GET.thinktank %}&thinktank={{ request.GET.thinktank }}{% endif %}">
                    <i class="fas fa-chevron-left"></i> 上一页
                </a>
            </li>
        {% else %}
            <li class="page-item disabled">
                <span class="page-link">
                    <i class="fas fa-chevron-left"></i> 上一页
                </span>
            </li>
        {% endif %}

        <!-- 页码 -->
        {% with articles.number as current_page %}
        {% for page_num in articles.paginator.page_range %}
             <!-- 显示第一页和最后一页 -->
             {% if page_num == 1 or page_num == articles.paginator.num_pages %}
                  {% if page_num == current_page %}
                      <li class="page-item active">
                          <span class="page-link">{{ page_num }}</span>
                      </li>
                  {% else %}
                      <li class="page-item">
                          <a class="page-link" href="{% url 'webui:articles' %}?page={{ page_num }}{% if request.GET.thinktank %}&thinktank={{ request.GET.thinktank }}{% endif %}">{{ page_num }}</a>
                      </li>
                  {% endif %}
             <!-- 显示当前页前后各2页 -->
             {% elif page_num >= current_page|add:"-2" and page_num <= current_page|add:"2" %}
                  {% if page_num == current_page %}
                      <li class="page-item active">
                          <span class="page-link">{{ page_num }}</span>
                      </li>
                  {% else %}
                      <li class="page-item">
                          <a class="page-link" href="{% url 'webui:articles' %}?page={{ page_num }}{% if request.GET.thinktank %}&thinktank={{ request.GET.thinktank }}{% endif %}">{{ page_num }}</a>
                      </li>
                  {% endif %}
             <!-- 显示省略号 -->
             {% elif page_num == current_page|add:"-3" and current_page > 4 %}
                  <li class="page-item disabled">
                      <span class="page-link">...</span>
                  </li>
             {% elif page_num == current_page|add:"3" and current_page < articles.paginator.num_pages|add:"-3" %}
                  <li class="page-item disabled">
                      <span class="page-link">...</span>
                  </li>
             {% endif %}
        {% endfor %}
        {% endwith %}

        <!-- 下一页 -->
        {% if articles.has_next %}
            <li class="page-item">
                <a class="page-link" href="{% url 'webui:articles' %}?page={{ articles.next_page_number }}{% if request.GET.thinktank %}&thinktank={{ request.GET.thinktank }}{% endif %}">
                    下一页 <i class="fas fa-chevron-right"></i>
                </a>
            </li>
        {% else %}
            <li class="page-item disabled">
                <span class="page-link">
                    下一页 <i class="fas fa-chevron-right"></i>
                </span>
            </li>
        {% endif %}
    </ul>
</nav>
{% endif %}

{% else %}
    <!-- 空状态 -->
    <div class="text-center py-5">
        <i class="fas fa-newspaper fa-3x text-muted mb-3"></i>
        <h4 class="text-muted">暂无文章</h4>
        <p class="text-muted">请先运行爬取任务来获取文章内容</p>
        <!-- 修改点15: url_for -> url -->
        <a href="{% url 'webui:admin' %}" class="btn btn-primary">
            <i class="fas fa-cogs me-1"></i>管理任务
        </a>
    </div>
{% endif %}
{% endblock %}